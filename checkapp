<?xml version="1.1" encoding="UTF-8"?><flow-definition plugin="workflow-job@2.32">
  <actions/>
  <description/>
  <keepDependencies>false</keepDependencies>
  <properties>
    <hudson.plugins.jira.JiraProjectProperty plugin="jira@3.0.7"/>
  </properties>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.67">
    <script>node() {
def DockerImage = "webserver:1.2"

stage('Pre') { // Run pre-build steps
  cleanWs()
  sh "docker rm -f webserver || true"
}

stage('Git') { // Get code from GitLab repository
  git branch: 'master',
    url: 'https://github.com/royselekter/flask-http.git'
}

stage('Build') { // Run the docker build
  sh "docker build --tag ${DockerImage} ."
}
stage('Run') { // Run the built image
  sh "docker run -d --name webserver --rm -p 8081:5000 ${DockerImage}; sleep 5"
}

stage('Test') { // Run tests on container
  def dockerOutput = sh (
      script: 'curl http://192.168.15.30:8081/goaway',
      //script: 'curl http://localhost:8081/goaway',
      returnStdout: true
      ).trim()
//  sh "docker rm -f webserver"

  if ( dockerOutput == 'GO AWAY!' ) {
      currentBuild.result = 'SUCCESS'
  } else {
      currentBuild.result = 'FAILURE'
      sh "echo Webserver returned ${dockerOutput}"
  }
  return
}
stage('Push') { // Push the built image to docker hub
   withDockerRegistry(credentialsId: 'docker-hub') {
      sh "docker tag ${DockerImage} royselekter/${DockerImage}"
      sh "docker push royselekter/${DockerImage}"
   }
}

stage ('Deploy') { // deploy to k8s
  sshagent(credentials : ['ssh_jen']) {
     sh 'ssh -o StrictHostKeyChecking=no ubuntu@192.168.15.40 uptime'
     sh 'ssh ubuntu@192.168.15.40 ""kubectl apply -f /home/ubuntu/k8s_repo/k8s-pod.yml""'
   }
 }
}</script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
  <disabled>false</disabled>
